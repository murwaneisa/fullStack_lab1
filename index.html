<!DOCTYPE html>
<html>
  <head>
    <title>Bootstrap Example</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body>
    <div class="container">
      <table id="albums-table" class="table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Artist</th>
            <th>Year</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Albums will be dynamically added here -->
        </tbody>
      </table>
    </div>

    <div class="container" id="show_details">
      <!-- render details -->
    </div>

    <script>
      fetch("http://localhost:3000/api/albums")
        .then((response) => response.json())
        .then((data) => {
          const tableBody = document.querySelector("#albums-table tbody");

          // Loop through the albums and create a new row for each one
          data.forEach((album) => {
            const row = document.createElement("tr");
            // Add the album data to the row
            row.innerHTML = `
        <td>${album.title}</td>
        <td>${album.artist}</td>
        <td>${album.year}</td>
        <td>
          <button class=" btn btn-secondary update-btn" data-id="${album._id}">Update</button>
          <button class=" btn btn-danger delete-btn" data-id="${album._id}">Delete</button>
          <button class="btn btn-primary details-btn" data-id="${album._id}" data-title="${album.title}"  >Details</button>

        </td>
      `;

            tableBody.appendChild(row);
          });
        })
        .catch((error) => {
          console.error("Error fetching albums:", error);
        });

      // Add event listener for delete button clicks
      document.addEventListener("click", (event) => {
        // Delete album form database
        if (event.target.classList.contains("delete-btn")) {
          const albumId = event.target.getAttribute("data-id");
          // Confirm deletion with user
          if (confirm("Are you sure you want to delete this album?")) {
            // Send delete request to API
            fetch(`http://localhost:3000/api/albums/${albumId}`, {
              method: "DELETE",
            })
              .then((response) => response.json())
              .then((data) => {
                // Remove row from table
                event.target.closest("tr").remove();
              })
              .catch((error) => {
                console.error("Error deleting album:", error);
                document.querySelector(
                  "#show_details"
                ).innerHTML = ` <h2>server error to delete the album</h2>`;
              });
          }
        }

        if (event.target.classList.contains("details-btn")) {
          const albumDetailsTitle = event.target.getAttribute("data-title");

          const searchTerm = encodeURIComponent(albumDetailsTitle);

          // get data to show  specific album
          fetch(`http://localhost:3000/api/albums/${searchTerm}`)
            .then((response) => response.json())
            .then((data) => {
              const { title, artist, year } = data[0];
              //console.log("album", artist);
              document.querySelector(
                "#show_details"
              ).innerHTML = ` <h2>ALbum Details</h2>
              <table class="table">
                <thead>
                  <tr>
                    <th>Firstname</th>
                    <th>Lastname</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>${title}</td>
                    <td>${artist}</td>
                    <td>${year}</td>
                  </tr>
                </tbody>
              </table>`;
            })
            .catch((error) => {
              console.error(" error");
              document.querySelector(
                "#show_details"
              ).innerHTML = ` <h2>server error to get the album</h2>`;
            });
        }
      });
    </script>
  </body>
</html>
